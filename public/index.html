<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spotify Moment</title>
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@5.9.55/css/materialdesignicons.min.css"> -->
    <style>
      * {
        padding: 0;
        margin: 0;
        outline: 0;
        box-sizing: border-box;
        user-select: none;
      }

      html,
      body {
        background-color: transparent;
      }

      .container {
        width: 100vw;
        height: 100vh;

        display: flex;

        justify-content: center;
        align-items: center;
      }

      .main {
        display: flex;
        justify-content: center;
        align-items: center;
        transition: opacity 300ms ease-in-out;
      }

      .hidden {
        opacity: 0;
      }

      .shadow {
        box-shadow: 0 2.8px 2.2px rgba(0, 0, 0, 0.02),
          0 6.7px 5.3px rgba(0, 0, 0, 0.028), 0 12.5px 10px rgba(0, 0, 0, 0.035),
          0 22.3px 17.9px rgba(0, 0, 0, 0.042),
          0 41.8px 33.4px rgba(0, 0, 0, 0.05), 0 100px 80px rgba(0, 0, 0, 0.07);
      }

      .artwork {
        width: 260px;
        height: 260px;
        background-size: 260px;
        display: inline-block;
        background-color: #2a2a2a;
        z-index: 100;
        position: relative;
      }

      .infobox {
        height: 140px;
        width: 400px;
        background-position: center;
        background-size: 400px;
        display: inline-block;
        position: relative;
        background-color: #f8f8f8;

        margin-top: 64px;
      }

      .infobox-image-container {
        overflow: hidden;
        position: absolute;
        height: 140px;
        width: 400px;
      }

      .infobox-image {
        height: 600px;
        width: 600px;
        filter: blur(12px);
        background-size: 400px;
        background-position: center;
        overflow: hidden;
        display: inline-block;
        margin-top: -100px;
        margin-left: -100px;
      }

      .infobox-info {
        height: 140px;
        width: 400px;
        z-index: 1000;
        font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande",
          "Lucida Sans", Arial, sans-serif;
        color: rgb(250, 250, 250);
        text-shadow: 1px 1px 2px #2a2a2a;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: clip;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .infobox-wrapper {
        width: 400px;
        display: inline-block;
      }

      .title {
        font-size: 32px;
        font-weight: 600;
      }

      .artist {
        font-size: 20px;
      }

      .marquee span {
        display: inline-block;
        padding-left: 100%;
        will-change: transform;
        animation: marquee 15s linear infinite;
      }

      @keyframes marquee {
        0% {
          transform: translate(0, 0);
        }
        100% {
          transform: translate(-100%, 0);
        }
      }

      .progressbar {
        width: 0px;
        height: 6px;
        position: absolute;
        bottom: 0;
        left: 0;
        display: inline-block;
        background-color: rgba(0, 0, 0, 0.35);
        transition: width 1s linear;
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
        filter: drop-shadow(0px 0px 2px rgb(255, 255, 255));
      }

      @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap');

      .watermark {
        position: absolute;
        bottom: 4px;
        left: 4px;
        color: rgba(255, 255, 255, 0.15);
        font-size: 12px;
        font-weight: 300;
        font-family: 'Roboto', sans-serif;
      }

      .pause-icon-container {
        width: 260px;
        height: 260px;
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .pause-icon {
        width: 260px;
        height: 260px;
        color: rgba(255, 255, 255, 0.5);
        transition: all 500ms ease-in-out;
      }

      .pause-icon.hidden {
        transform: scale(0) rotateZ(90deg);
        opacity: 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="main hidden">
        <div
          class="artwork shadow"
        >
        <div class="pause-icon-container">
          <div class="pause-icon">
<svg viewBox="0 0 24 24">
    <path fill="currentColor" d="M15,16H13V8H15M11,16H9V8H11M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />
</svg>
          </div>
        </div>
        <div class="watermark">Spotify Moment</div>
      </div>
        <div class="infobox shadow">
          <div class="infobox-image-container">
            <img class="infobox-image"></img>
          </div>
          <div class="infobox-info">
            <div class="infobox-wrapper">
                <p class="title marquee">
                <span>TITLE</span>
              </p>
              <p class="artist marquee">
                <span>ARTIST</span>
              </p>
            </div>
            <div class="progressbar"></div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    const url = new URL(window.location.href);
    const sleep = function (ms = 100) {
      return new Promise(function (resolve) {
        setTimeout(resolve, ms);
      });
    };

    const main = document.querySelector(".main");
    const title = document.querySelector(".title");
    const artist = document.querySelector(".artist");
    const artwork = document.querySelector(".artwork");
    const infobox = document.querySelector(".infobox");
    const infoboxImage = document.querySelector(".infobox-image");
    const progressbar = document.querySelector(".progressbar");
    const pauseIcon = document.querySelector(".pause-icon");

    let lastInfo = {};

    if (url.searchParams.has("doNotHide")) {
      main.classList.remove("hidden");
    } else {
      pauseIcon.classList.add("hidden");
    }

    setInterval(async () => {
      const info = await getState();
      if (!info.hasOwnProperty("is_playing") && !url.searchParams.has("doNotRedirect")) return window.location.replace("/auth");
      
      if (!info.is_playing) {
        if (url.searchParams.has("doNotHide")) {
          pauseIcon.classList.remove("hidden");
        } else {
          main.classList.add("hidden");
        }
      }

      if (((lastInfo || {}).item || {}).name != info.item.name) {
        main.classList.add("hidden");
        const _title = info.item.name;
        const _artists = info.item.artists.map(i=>i.name).join(", ");
        document.title = `${_title} - ${_artists} | Spotify Moment`;
        await sleep(300);

        title.innerHTML = `<span>${_title}</span>`;
        artist.innerHTML = `<span>${_artists}</span>`;
        updateImages(info.item.album.images[0].url);
        main.classList.remove("hidden");
      }

      if (info.is_playing) {
        progressbar.setAttribute("style", `width: ${percentage(info.progress_ms,info.item.duration_ms)*4}px`);
        
        if (url.searchParams.has("doNotHide")) {
          pauseIcon.classList.add("hidden");
        } else {
          main.classList.remove("hidden");
        }
      }

      lastInfo = info;
    }, 1000);

    async function getState() {
      let state = await fetch("/state").then((d) => d.json());
      return state;
    }

    function updateImages(url) {
      artwork.setAttribute(
        "style",
        `background-image: url('${url}')`
      );

      infoboxImage.setAttribute(
        "src",
        url
      );
    }

    function percentage(partialValue, totalValue) {
      return (100 * partialValue) / totalValue;
    }

    const bgColor = url.searchParams.get("bgColor");
    if (bgColor) {
      document.documentElement.setAttribute("style",`background-color:#${bgColor};`);
    }
    if (url.searchParams.has("hideWatermark")) {
      document.querySelector(".watermark").classList.add("hidden");
    }
  </script>
</html>
